<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='adminpanel.css') }}"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Gujarat Transport Solutions | Bus & Truck Booking"
    />
    <meta
      property="og:description"
      content="Book bus tickets and truck transport online. Safe travel, trusted cargo delivery, affordable prices, and easy booking across India."
    />
    <meta property="og:url" content="https://gujarattransportation.com" />
    <meta
      property="og:image"
      content="https://gujarattransportation.com/static/img/og-cover.jpg"
    />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Gujarat Transport Solutions" />
    <meta
      name="twitter:description"
      content="Online bus and truck booking platform with secure payment and real-time service."
    />
    <meta
      name="twitter:image"
      content="https://gujarattransportation.com/static/img/og-cover.jpg"
    />
  </head>

  <body>
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <img
        src="{{ url_for('static', filename='img/admin-logo.png') }}"
        alt="Logo"
        class="logo"
      />
      <h2>Admin-Panel</h2>

      <a href="/adminpanel" class="active">
        <i class="fa fa-chart-line"></i>
        <span data-lang="dashboard">Dashboard</span>
      </a>

      <a href="/bus-booking">
        <i class="fa fa-bus"></i> <span data-lang="bus">Bus Booking</span>
      </a>

      <a href="/trucks-shipment">
        <i class="fa fa-truck"></i>
        <span data-lang="truck">Trucks Shipment</span>
      </a>

      <a href="/users">
        <i class="fa fa-users"></i> <span data-lang="users">Manage Users</span>
      </a>

      <a href="/queries">
        <i class="fa fa-message"></i>
        <span data-lang="contact">Contact Queries</span>
      </a>

      <a href="/logout">
        <i class="fa fa-right-from-bracket"></i>
        <span data-lang="logout">Logout</span>
      </a>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <!-- TOP BAR -->
      <div class="topbar">
        <h1 data-lang="dashboard">Dashboard</h1>

        <div class="top-controls">
          <input
            id="tableSearch"
            type="text"
            placeholder="Search bookings..."
          />
          <i class="fa fa-bell"></i>

          <div class="admin-menu">
            <i class="fa fa-user"><span> Admin â–¾</span></i>
            <div class="admin-dropdown">
              <a href="/profile"><i class="fa fa-user"></i> My Profile</a>
              <a href="/mybookings"
                ><i class="fa fa-briefcase"></i> My Bookings</a
              >
              <a href="/logout"
                ><i class="fa fa-right-from-bracket"></i> Logout</a
              >
            </div>
          </div>
        </div>
      </div>

      <!-- WELCOME -->
      <div class="welcome-card">
        <h2>ðŸ”° Welcome to the Admin Dashboard ðŸ”°</h2>
        <p>
          Manage all bookings, users, and revenue from one powerful control
          panel
        </p>
      </div>

      <!-- STATS -->
      <div class="cards">
        <div class="card blue">
          <i class="fa fa-bus"></i>
          <p>Bus Bookings</p>
          <h3 id="busCount">{{ bus_count }}</h3>
          <small class="muted">Live from /api/bus-admin</small>
        </div>

        <div class="card purple">
          <i class="fa fa-truck"></i>
          <p>Truck Shipments</p>
          <h3 id="truckCount">{{ truck_count }}</h3>
          <small class="muted">Live from /api/truck-admin</small>
        </div>

        <div class="card orange">
          <i class="fa fa-users"></i>
          <p>Total Users</p>
          <h3 id="userCount">{{ user_count }}</h3>
          <small class="muted">Live from /api/admin-stats</small>
        </div>

        <div class="card green">
          <i class="fa fa-rupee-sign"></i>
          <p>Total Revenue</p>
          <h3>â‚¹ <span id="totalRevenue">{{ total_revenue }}</span></h3>
          <small class="muted">Truck + Bus revenue</small>
        </div>

        <!-- CHART -->
        <div class="chart-box">
          <canvas id="analytics"></canvas>
        </div>

        <!-- TABLES -->
        <div class="table-box">
          <h3>Recent Bookings (Bus + Truck)</h3>
          <table id="recentBookingsTable" class="search-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Date</th>
              </tr>
            </thead>

            <tbody id="recentBookingsBody">
              {% if bookings and bookings|length > 0 %} {% for b in bookings %}
              <tr>
                <td>{{ b.username }}</td>
                <td>{{ b.type }}</td>
                <td>â‚¹ {{ b.amount }}</td>
                <td>{{ b.date }}</td>
              </tr>
              {% endfor %} {% else %}
              <tr>
                <td colspan="4" style="text-align: center">No bookings yet</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
          <small class="muted">Shows latest 5 (auto-sorted by date)</small>
        </div>

        <div class="table-box">
          <h3>Recent Signups</h3>
          <table id="recentUsersTable">
            <thead>
              <tr>
                <th>Full Name</th>
                <th>Username</th>
                <th>Email</th>
              </tr>
            </thead>

            <tbody id="recentUsersBody">
              {% for u in users %}
              <tr>
                <td>{{ u.fullname }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // ---------- helpers ----------
      function toInt(val) {
        const digits = String(val ?? "").replace(/[^\d]/g, "");
        return digits ? parseInt(digits, 10) : 0;
      }

      function parseDMYHM(dateStr) {
        // expects "dd-mm-YYYY HH:MM"
        const s = String(dateStr || "");
        const m = s.match(/^(\d{2})-(\d{2})-(\d{4})\s+(\d{2}):(\d{2})$/);
        if (!m) return 0;
        const dd = +m[1],
          mm = +m[2],
          yyyy = +m[3],
          hh = +m[4],
          mi = +m[5];
        return new Date(yyyy, mm - 1, dd, hh, mi, 0).getTime();
      }

      function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.innerText = value;
      }

      // ---------- chart ----------
      let analyticsChart = null;

      function renderChart({ users, bus, truck }) {
        const canvas = document.getElementById("analytics");
        if (!canvas) return;

        const maxVal = Math.max(users || 0, bus || 0, truck || 0);
        let step = 50;
        if (maxVal > 150) step = 100;
        if (maxVal > 500) step = 500;

        if (analyticsChart) analyticsChart.destroy();

        analyticsChart = new Chart(canvas, {
          type: "line",
          data: {
            labels: ["Users", "Bus", "Truck"],
            datasets: [
              {
                label: "Users",
                data: [users, 0, 0],
                borderColor: "#ff8c00",
                tension: 0.4,
              },
              {
                label: "Bus",
                data: [0, bus, 0],
                borderColor: "#38bdf8",
                tension: 0.4,
              },
              {
                label: "Truck",
                data: [0, 0, truck],
                borderColor: "#7c3aed",
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: step } } },
            plugins: { legend: { display: true } },
          },
        });
      }

      // ---------- tables ----------
      function renderRecentBookings(rows) {
        const tbody = document.getElementById("recentBookingsBody");
        if (!tbody) return;

        if (!rows || rows.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center">No bookings yet</td></tr>`;
          return;
        }

        tbody.innerHTML = rows
          .map(
            (r) => `
          <tr>
            <td>${r.username || "guest"}</td>
            <td>${r.type || "-"}</td>
            <td>â‚¹ ${toInt(r.amount || r.payment || 0).toLocaleString("en-IN")}</td>
            <td>${r.date || ""}</td>
          </tr>
        `,
          )
          .join("");
      }

      function renderRecentUsers(users) {
        const tbody = document.getElementById("recentUsersBody");
        if (!tbody) return;

        if (!users || users.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" style="text-align:center">No users</td></tr>`;
          return;
        }

        tbody.innerHTML = users
          .map(
            (u) => `
          <tr>
            <td>${u.fullname || ""}</td>
            <td>${u.username || ""}</td>
            <td>${u.email || ""}</td>
          </tr>
        `,
          )
          .join("");
      }

      // ---------- live refresh (all data) ----------
      async function refreshDashboard() {
        try {
          const [usersRes, truckRes, busRes] = await Promise.all([
            fetch("/api/admin-stats"),
            fetch("/api/truck-admin"),
            fetch("/api/bus-admin"),
          ]);

          const usersData = await usersRes.json();
          const truckData = await truckRes.json();
          const busData = await busRes.json();

          // counts
          const userCount = toInt(usersData.user_count);
          const truckCount = toInt(truckData.total_shipments);
          const busCount = toInt(busData.total_bookings);

          setText("userCount", userCount);
          setText("truckCount", truckCount);
          setText("busCount", busCount);

          // revenue (truck + bus)
          const truckRevenue = toInt(truckData.total_revenue);
          const busRevenue = toInt(busData.total_revenue);
          setText(
            "totalRevenue",
            (truckRevenue + busRevenue).toLocaleString("en-IN"),
          );

          // recent signups
          renderRecentUsers(usersData.users || []);

          // merge bookings (latest 5)
          const merged = [];

          // trucks: API returns {shipments:[...]} with payment + date
          (truckData.shipments || []).forEach((s) => {
            merged.push({
              username: s.username || "guest",
              type: "Truck",
              amount: s.payment,
              date: s.date || "",
            });
          });

          // bus: API returns {bookings:[...]} with payment + date
          (busData.bookings || []).forEach((b) => {
            merged.push({
              username: b.username || "guest",
              type: "Bus",
              amount: b.payment,
              date: b.date || "",
            });
          });

          merged.sort((a, b) => parseDMYHM(b.date) - parseDMYHM(a.date));
          renderRecentBookings(merged.slice(0, 5));

          // chart
          renderChart({ users: userCount, bus: busCount, truck: truckCount });
        } catch (e) {
          console.log("Dashboard refresh failed:", e);
        }
      }

      // Search filter (recent bookings table only)
      (function () {
        const input = document.getElementById("adminSearch");
        const tbody = document.getElementById("recentBookingsBody");
        if (!input || !tbody) return;

        input.addEventListener("input", () => {
          const q = input.value.trim().toLowerCase();
          const rows = Array.from(tbody.querySelectorAll("tr"));
          rows.forEach((tr) => {
            const text = tr.innerText.toLowerCase();
            tr.style.display = text.includes(q) ? "" : "none";
          });
        });
      })();

      // initial + poll
      refreshDashboard();
      setInterval(refreshDashboard, 5000);
    </script>
    <script>
      (function () {
        const searchInput = document.getElementById("tableSearch");
        const tables = document.querySelectorAll(".search-table");
        searchInput.addEventListener("keyup", function () {
          const value = this.value.toLowerCase().trim();

          tables.forEach((table) => {
            const rows = table.querySelectorAll("tbody tr");

            rows.forEach((row) => {
              row.style.display = row.innerText.toLowerCase().includes(value)
                ? ""
                : "none";
            });
          });
        });
      })();
    </script>
  </body>
</html>
